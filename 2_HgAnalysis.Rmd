---
title: "2_HgAnalysis"
author: "Jackie Gerson"
date: "3/24/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
```

#This file reads in and analyzes mercury data in surface waters for Madre de Dios, Peru.

```{r cars}
#Read in data files and combine into one dataframe
oxbow.all<-read.csv("in/Oxbow.lake.data.csv")
mining.pond.all<-read.csv("in/Mining.pond.data.csv")
river.all<-read.csv("in/River.data.csv")

river.all.subset<-river.all[,c("Site.number","Site.type","Collection.date","Collection.time","Lat","Long","TSS.mg.L","Ave.THg.sed.ug.g","THg.water.ng.L","MeHg.water.ng.L","Percent.MeHg.water")]

## Update the oxbow lake/mining pond coordinates with the centerpoints pulled from EE
## This is just because some of the sample points were on the edges and for analysis we
## need centerpoints.
oxbowCenters <- read.csv('in/LenticCenterPoints.csv')

oxbow.all <- oxbow.all %>% select(-Lat, -Long) %>%
  left_join(oxbowCenters %>% select(Collection.date = Date, Collection.time = Time, Lat, Long))

oxbow.mining.all<-rbind(oxbow.all,mining.pond.all)

water.all<-rbind(oxbow.mining.all,river.all.subset) %>%
  mutate(Site.type = factor(Site.type, level =c("river.upstream", "oxbow.lake.upstream", "mining.pond", "river.downstream", "oxbow.lake.downstream"),
                            labels = c("River Upstream", "Oxbow Upstream", "Mining Pond", "River Downstream", "Oxbow Downstream")))
```

## Make some figures

```{r cars}
#Create boxplots to compare Hg concentrations across surface water types
cb <- c("#56B4E9","#E69F00","#999999","#0072B2","#D55E00")

## Total Hg
tukeyThg <- tibble(Site.type = c('River Upstream', 'Oxbow Upstream', 'Mining Pond', 'River Downstream', 'Oxbow Downstream'), TukeyStats = c('a','a','ab','b','a'))

g1<-ggplot(water.all,aes(x=Site.type, y=THg.water.ng.L)) + 
  geom_boxplot(aes(fill=Site.type)) +
  geom_label(data = tukeyThg, aes(y = Inf, label = TukeyStats), vjust = 2, label.size = .2) +
  labs(x="",y="\nTHg (ng/L)") + 
  scale_y_continuous(trans = 'log10') +
  theme_bw() + 
  theme(axis.text.x=element_blank(),
        legend.position="top") + 
  scale_fill_manual(values=cb) + 
  labs(fill="") 


## MeHg
tukeyMeHg <- tibble(Site.type = c('River Upstream', 'Oxbow Upstream', 'Mining Pond', 'River Downstream', 'Oxbow Downstream'), TukeyStats = c('a','ab','b','b','b'))
  
g2<-ggplot(water.all,aes(x=Site.type, y=MeHg.water.ng.L)) + 
  geom_boxplot(aes(fill=Site.type)) +
  geom_label(data = tukeyMeHg, aes(y = Inf, label = TukeyStats), vjust = 2, label.size = .2) +
  theme_bw()+
  labs(x="",y="MeHg (ng/L)")+
  theme(axis.text.x=element_blank(),
        legend.position="none") +
  scale_fill_manual(values=cb)

## Percent MeHg

tukeyPMeHg <- tibble(Site.type = c('River Upstream', 'Oxbow Upstream', 'Mining Pond', 'River Downstream', 'Oxbow Downstream'), TukeyStats = c('a','a','a','b','a'))

g3<-ggplot(water.all,aes(x=Site.type, y=Percent.MeHg.water)) + 
  geom_boxplot(aes(fill=Site.type)) +
  geom_label(data = tukeyPMeHg, aes(y = Inf, label = TukeyStats), vjust = 2, label.size = .2) +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 20, hjust = 1)) +
  labs(x="",y="Percent Hg\nas MeHg")+
  scale_fill_manual(values=cb) +
  scale_x_discrete(labels=c("River\nUpstream","Oxbow\nUpstream","Mining\nPond","River\nDownstream","Oxbow\nDownstream"))

## Average Sediment THg

tukeySTHg <- tibble(Site.type = c('River Upstream', 'Oxbow Upstream', 'Mining Pond', 'River Downstream', 'Oxbow Downstream'), TukeyStats = c('a','ab','ab','a','b'))

g4 <- ggplot(water.all,aes(x=Site.type, y=Ave.THg.sed.ug.g)) + 
  geom_boxplot(aes(fill=Site.type)) +
  geom_label(data = tukeySTHg, aes(y = Inf, label = TukeyStats), vjust = 2, label.size = .2) +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 20, hjust = 1)) +
  labs(x="", y="Sediment THg\n(ug/g)") +
  scale_x_discrete(labels=c("River\nUpstream","Oxbow\nUpstream","Mining\nPond","River\nDownstream","Oxbow\nDownstream"))+
  scale_fill_manual(values=cb) +
  theme(legend.position="top") +
  labs(fill="") + 
  coord_cartesian(ylim = c(0,.3))

tukeyTSS <- tibble(Site.type = c('River Upstream', 'Oxbow Upstream', 'Mining Pond', 'River Downstream', 'Oxbow Downstream'), TukeyStats = c('ab','a','ab','c','b'))

g5 <- ggplot(water.all,aes(x=Site.type, y=TSS.mg.L)) + 
  geom_boxplot(aes(fill=Site.type)) +
  geom_label(data = tukeyTSS, aes(y = Inf, label = TukeyStats), vjust = 2, label.size = .2) +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 20, hjust = 1)) +
  labs(x="", y="TSS (mg/L)") +
  scale_x_discrete(labels=c("River\nUpstream","Oxbow\nUpstream","Mining\nPond","River\nDownstream","Oxbow\nDownstream"))+
  scale_fill_manual(values=cb) +
  theme(legend.position="top") +
  labs(fill="")

#Create frequency distributions to compare Hg concentrations across surface water types
water.all.THg<-water.all[order(-water.all$THg.water.ng.L),]
water.all.THg$ID<-seq.int(nrow(water.all.THg))
water.all.MeHg<-water.all[order(-water.all$MeHg.water.ng.L),]
water.all.MeHg$ID<-seq.int(nrow(water.all.MeHg))
water.all.Percent<-water.all[order(-water.all$Percent.MeHg.water),]
water.all.Percent$ID<-seq.int(nrow(water.all.Percent))
water.all.THg.sed<-water.all[order(-water.all$Ave.THg.sed.ug.g),]
water.all.THg.sed$ID<-seq.int(nrow(water.all.THg.sed))
water.all.THg.TSS<-water.all[order(-water.all$TSS.mg.L),]
water.all.THg.TSS$ID<-seq.int(nrow(water.all.THg.TSS))

#Total Hg
gg1<-ggplot(water.all.THg, aes(x=ID, y=THg.water.ng.L, fill=Site.type))+
  geom_bar(stat="identity")+
  theme_bw()+labs(x="",y="")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        legend.position="none")+
  labs(fill="")+
  scale_fill_manual(values=cb)

# MeHg
gg2<-ggplot(water.all.MeHg, aes(x=ID, y=MeHg.water.ng.L,  fill=Site.type))+
  geom_bar(stat="identity")+
  theme_bw()+
  labs(x="",y="")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        legend.position="none")+
  scale_fill_manual(values=cb)+
  labs(fill="")

## Percent MeHg
gg3<-ggplot(water.all.Percent, aes(x=ID, y=Percent.MeHg.water, fill=Site.type))+
  geom_bar(stat="identity")+
  theme_bw()+
  labs(x="\nIndividual Samples",y="",fill="")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        legend.position="none")+
  scale_fill_manual(values=cb)

## Sediment THg
gg4<-ggplot(water.all.THg.sed, aes(x=ID,y=Ave.THg.sed.ug.g,fill=Site.type))+
  geom_bar(stat="identity")+
  theme_bw()+
  labs(x="Individual Samples",y="")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x = element_blank())+
  labs (fill="\ncount")+scale_fill_manual (values=cb)

## Sediment THg
gg5<-ggplot(water.all.THg.TSS, aes(x=ID,y=TSS.mg.L,fill=Site.type))+
  geom_bar(stat="identity")+
  theme_bw()+
  labs(x="Individual Samples",y="")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x = element_blank())+
  labs(fill="\ncount")+scale_fill_manual(values=cb)


#Combine plots into a water column figure and sediment figure

#Water column figure
g <- ggpubr::ggarrange(g1,gg1,g2,gg2,g3,gg3,nrow=3,ncol=2,common.legend=TRUE)

ggsave('figures/Final/HgAnalysis.png', plot = g, width = 7, units = 'in', dpi = 600)

#Sediment figure
ggpubr::ggarrange(g4,gg4,nrow=1,ncol=2,common.legend=TRUE)
ggsave('figures/Final/HgSed.png', width = 7, height = 3.5, units = 'in', dpi = 600)

##TSS Figure
ggpubr::ggarrange(g5,gg5,nrow=1,ncol=2,common.legend=TRUE)
ggsave('figures/Final/HgTSS.png', width = 7, height = 3.5, units = 'in', dpi = 600)
##Water.all and tss mg/L column same as gg4 but with TSS
```



```{r cars}
## Take a look at distributions and run some statistics

#Calculate summary statistics for Hg concentrations in water
water.all %>%  
  group_by(Site.type) %>% 
  summarize(n=n(),
            mean_THg = mean(THg.water.ng.L, na.rm = TRUE),
            sd_THg=sd(THg.water.ng.L, na.rm = TRUE),
            mean_MeHg=mean(MeHg.water.ng.L,na.rm=TRUE),
            sd_MeHg=sd(MeHg.water.ng.L, na.rm = TRUE),
            mean_Percent=mean(Percent.MeHg.water,na.rm=T),
            sd_Percent=sd(Percent.MeHg.water, na.rm = TRUE))

#Compare THg concentrations in water by surface water type

shapiro.test(residuals(object =aov(THg.water.ng.L~Site.type,data=water.all)  ))
# p<0.05-data are not normally distributed
kruskal.test(THg.water.ng.L ~ Site.type, data = water.all)
FSA::dunnTest(THg.water.ng.L ~ Site.type, data = water.all)

#Compare MeHg concentrations in water by surface water type
shapiro.test(residuals(object =aov(MeHg.water.ng.L~Site.type,data=water.all)  ))
# p<0.05-data are not normally distributed
kruskal.test(MeHg.water.ng.L ~ Site.type, data = water.all)
FSA::dunnTest(MeHg.water.ng.L ~ Site.type, data = water.all)

#Compare %MeHg concentrations in water by surface water type
shapiro.test(residuals(object =aov(Percent.MeHg.water~Site.type,data=water.all)  ))
# p<0.05-data are not normally distributed
kruskal.test(Percent.MeHg.water ~ Site.type, data = water.all)
FSA::dunnTest(Percent.MeHg.water ~ Site.type, data = water.all)

#Compare THg concentrations in sediment by surface water type
shapiro.test(residuals(object =aov(Ave.THg.sed.ug.g~Site.type,data=water.all)  ))
# p<0.05-data are not normally distributed
kruskal.test(Ave.THg.sed.ug.g ~ Site.type, data = water.all)
FSA::dunnTest(Ave.THg.sed.ug.g ~ Site.type, data = water.all)

#TSS vs. THg for mining ponds and oxbow lakes
ggplot(water.all,aes(x=TSS.mg.L,y=THg.water.ng.L,color=Site.type))+
  geom_point(size=2.5,alpha=.7)+
  theme_bw()+
  labs(y="Total Mercury (ng/L)",x="Total Suspended Solids (mg/L)",color="")+
  scale_color_manual(values=cb)

ggsave('figures/Final/TSSvTHg.png', width = 5, height = 3, units = 'in', dpi = 600)

## Look at R2 and regression results
summary(lm(data=water.all,THg.water.ng.L~TSS.mg.L))

```


## Redo figure 3 normalized by TSS

```{r cars}
#Create boxplots to compare Hg concentrations across surface water types
cb <- c("#56B4E9","#E69F00","#999999","#0072B2","#D55E00")

water.all.norm <- water.all %>%
  mutate(THg.water.ng.L = THg.water.ng.L/TSS.mg.L,
         MeHg.water.ng.L = MeHg.water.ng.L/TSS.mg.L,
         Percent.MeHg.water = Percent.MeHg.water/TSS.mg.L)

## Total Hg
tukeyThg <- tibble(Site.type = c('River Upstream', 'Oxbow Upstream', 'Mining Pond', 'River Downstream', 'Oxbow Downstream'), TukeyStats = c('a','a','ab','b','a'))

g1<-ggplot(water.all.norm,aes(x=Site.type, y=THg.water.ng.L)) + 
  geom_boxplot(aes(fill=Site.type)) +
  geom_label(data = tukeyThg, aes(y = Inf, label = TukeyStats), vjust = 2, label.size = .2) +
  labs(x="",y="THg\n(ng/mg TSS)") + 
  scale_y_continuous(trans = 'log10') +
  theme_bw() + 
  theme(axis.text.x=element_blank(),
        legend.position="top") + 
  scale_fill_manual(values=cb) + 
  labs(fill="") 


## MeHg
tukeyMeHg <- tibble(Site.type = c('River Upstream', 'Oxbow Upstream', 'Mining Pond', 'River Downstream', 'Oxbow Downstream'), TukeyStats = c('a','ab','b','b','b'))
  
g2<-ggplot(water.all.norm,aes(x=Site.type, y=MeHg.water.ng.L)) + 
  geom_boxplot(aes(fill=Site.type)) +
  geom_label(data = tukeyMeHg, aes(y = Inf, label = TukeyStats), vjust = 2, label.size = .2) +
  theme_bw()+
  labs(x="",y="MeHg\n(ng/mg TSS)")+
  theme(axis.text.x=element_blank(),
        legend.position="none") +
  scale_fill_manual(values=cb)

## Percent MeHg

tukeyPMeHg <- tibble(Site.type = c('River Upstream', 'Oxbow Upstream', 'Mining Pond', 'River Downstream', 'Oxbow Downstream'), TukeyStats = c('a','a','a','b','a'))

g3<-ggplot(water.all.norm,aes(x=Site.type, y=Percent.MeHg.water)) + 
  geom_boxplot(aes(fill=Site.type)) +
  geom_label(data = tukeyPMeHg, aes(y = Inf, label = TukeyStats), vjust = 2, label.size = .2) +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 20, hjust = 1)) +
  labs(x="",y="Percent Hg\nas MeHg")+
  scale_fill_manual(values=cb) +
  scale_x_discrete(labels=c("River\nUpstream","Oxbow\nUpstream","Mining\nPond","River\nDownstream","Oxbow\nDownstream"))

#Create frequency distributions to compare Hg concentrations across surface water types
water.all.norm.THg<-water.all.norm[order(-water.all.norm$THg.water.ng.L),]
water.all.norm.THg$ID<-seq.int(nrow(water.all.norm.THg))
water.all.norm.MeHg<-water.all.norm[order(-water.all.norm$MeHg.water.ng.L),]
water.all.norm.MeHg$ID<-seq.int(nrow(water.all.norm.MeHg))
water.all.norm.Percent<-water.all.norm[order(-water.all.norm$Percent.MeHg.water),]
water.all.norm.Percent$ID<-seq.int(nrow(water.all.norm.Percent))
water.all.norm.THg.sed<-water.all.norm[order(-water.all.norm$Ave.THg.sed.ug.g),]
water.all.norm.THg.sed$ID<-seq.int(nrow(water.all.norm.THg.sed))
water.all.norm.THg.TSS<-water.all.norm[order(-water.all.norm$TSS.mg.L),]
water.all.norm.THg.TSS$ID<-seq.int(nrow(water.all.norm.THg.TSS))

#Total Hg
gg1<-ggplot(water.all.norm.THg, aes(x=ID, y=THg.water.ng.L, fill=Site.type))+
  geom_bar(stat="identity")+
  theme_bw()+labs(x="",y="")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        legend.position="none")+
  labs(fill="")+
  scale_fill_manual(values=cb)

# MeHg
gg2<-ggplot(water.all.norm.MeHg, aes(x=ID, y=MeHg.water.ng.L,  fill=Site.type))+
  geom_bar(stat="identity")+
  theme_bw()+
  labs(x="",y="")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        legend.position="none")+
  scale_fill_manual(values=cb)+
  labs(fill="")

## Percent MeHg
gg3<-ggplot(water.all.norm.Percent, aes(x=ID, y=Percent.MeHg.water, fill=Site.type))+
  geom_bar(stat="identity")+
  theme_bw()+
  labs(x="\nIndividual Samples",y="",fill="")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        legend.position="none")+
  scale_fill_manual(values=cb)


#Combine plots into a water column figure and sediment figure

#Water column figure
g <- ggpubr::ggarrange(g1,gg1,g2,gg2,g3,gg3,nrow=3,ncol=2,common.legend=TRUE)
g
ggsave('figures/Final/HgAnalysis.png', plot = g, width = 7, units = 'in', dpi = 600)
```


