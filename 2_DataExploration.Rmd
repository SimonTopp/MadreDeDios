---
title: "2_DataExploration"
author: "Simon Topp"
date: "2/3/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(googledrive)
library(sf)
library(mapview)
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
files <- drive_ls('MdD_Exports')

for(i in c(1:nrow(files))){
  path = paste0('out/',files$name[i])
  drive_download(as_id(files$id[i]), path, overwrite = T)
  }


rivAreas <- read.csv('out/AnnualRivAreas.csv') %>%
  mutate(area.km = Area/1000000)

ggplot(rivAreas, aes(x = year, y = area.km)) + geom_line()

```


# More systematic way with HydroSHED 8 watersheds

```{r}
drive_download('MdD_Exports/MdD_Hydroscape_TS_2yearv2.csv', 'out/MdD_Hydroscape_TS_2yearv2.csv', overwrite = T)

hs <- read_csv('out/MdD_Hydroscape_TS_2yearv2.csv')

basins.sf <- st_read('D:/GIS_Data/HydroSheds/hybas_sa_lev08_v1c.shp') %>%
  filter(HYBAS_ID %in% c(6080540660, 6080548660,6080540560,6080549240,6080549470,6080548950,6080552360,6080552360,6080552520, 6080546500))

mapView(basins.sf)

hs <- hs %>% select(-`system:index`) %>%
  spread(feature, area) %>%
  mutate(nonRivArea = waterArea - rivArea) %>%
  gather('feature', 'area', cl, rivArea, waterArea, nonRivArea) %>%
  mutate(Basin = ifelse(BasinID == 6080540660, 'UpStreamManuSouth', 
                        ifelse(BasinID == 6080548660, 'Reserva',
                               ifelse(BasinID == 6080540560, 'UpstreamManuNorth',
                                      ifelse(BasinID == 6080549240, 'Manu_Colorado',
                                             ifelse(BasinID == 6080549470, 'Colorado',
                                                    ifelse(BasinID == 6080548950, 'Colorado_InamWest',
                                                           ifelse(BasinID == 6080552360, 'Colorado_InamEast',
                                                              ifelse(BasinID == 6080552360, 'Colorado_InamEast',
                                                                     ifelse(BasinID == 6080552520, 'Inambari','Inam_Puerto'))))))))),
         area.km = area/1000000) %>%
  group_by(BasinID, Basin, feature) %>%
  mutate(area.norm = scale(area, scale = mean(area))) %>%
  ungroup()

ggplot(hs %>% filter(!feature %in% c('cl', 'waterArea')), aes(x = year, y = area.norm, color = feature)) + 
  geom_point(alpha = .4) + 
  geom_smooth(se = F) + 
  facet_wrap(~Basin, scales='free') +
  theme_bw()


ggplot(hs %>% filter(!feature %in% c('cl', 'waterArea'), Basin %in% c('Colorado', 'Inambari', 'Reserva', 'UpstreamManuNorth')), aes(x = year, y = area.norm, color = feature)) + 
  geom_point(alpha = .4) +
  scale_color_discrete(labels = c('Non-River Water Area', 'Riverine Water Area')) +
  geom_smooth(se = F) + 
  facet_wrap(~Basin, scales='free') +
  labs(x = 'Year', y = 'Centered Area (sq. km)', color = 'Area Type') +
  theme_bw()

##
hs %>% filter(feature == 'cl') %>% 
  ggplot(., aes(x = year, y = area.norm)) + geom_line() + facet_wrap(~Basin, scales = 'free')

##Check out erosion and accretion real quick
drive_download('MdD_Exports/MdD_ErosAcrec_2year.csv', 'out/MdD_ErosAcrec_2year.csv', overwrite = T)

ea <- read.csv('out/MdD_ErosAcrec_2year.csv')

ea <- ea %>%
  mutate(Basin = ifelse(BasinID == 6080540660, 'UpStreamManuSouth', 
                        ifelse(BasinID == 6080548660, 'Reserva',
                               ifelse(BasinID == 6080540560, 'UpstreamManuNorth',
                                      ifelse(BasinID == 6080549240, 'Manu_Colorado',
                                             ifelse(BasinID == 6080549470, 'Colorado',
                                                    ifelse(BasinID == 6080548950, 'Colorado_InamWest',
                                                           ifelse(BasinID == 6080552360, 'Colorado_InamEast',
                                                              ifelse(BasinID == 6080552360, 'Colorado_InamEast',
                                                                     ifelse(BasinID == 6080552520, 'Inambari','Inam_Puerto'))))))))),
         area.km = area/1000000) %>%
  group_by(BasinID, Basin, feature) %>%
  mutate(area.norm = scale(area, scale = mean(area))) %>%
  ungroup()


ggplot(ea %>% filter(feature == 'ErosionArea'), aes(x = year, y = area.norm, color = feature)) + 
  geom_line() + 
  geom_smooth(se = F) +
  theme_bw() +
  facet_wrap(~Basin, scales = 'free')

eaDiff <- ea %>%
  select(Basin, area.norm, feature, year) %>%
  spread(feature, area.norm) %>%
  mutate(AreaChange = AccretionArea - ErosionArea)

eaDiff %>%
  ggplot(., aes(x= year, y = AreaChange)) + geom_line() + geom_smooth(se = F) + facet_wrap(~Basin, scales = 'free_y') 



```


## Basic Sinuosity

```{r}
##Birds eye distances by watersehed


```



```{r}
## Check out the cocha Areas
drive_download('MdD_Exports/Cocha_Areas_CutOff.csv', 'out/Cocha_Areas_CutOff.csv')

cochaIDs <- read.csv('in/Cocha_Pond_Cords_Full.csv')

cochas <- read.csv('out/Cocha_Areas_CutOff.csv') %>%
  select(Unique_ID, year, area) %>%
  left_join(cochaIDs) %>%
  mutate(con2018 = ifelse(Unique_ID %in% c(3,4,5,8,9,15), T, F)) %>% mutate(version = 'Cut') %>%
  bind_rows(read.csv('out/Cocha_Areas.csv') %>%
  select(Unique_ID, year, area) %>%
  left_join(cochaIDs) %>%
  mutate(con2018 = ifelse(Unique_ID %in% c(3,4,5,8,9,15), T, F)) %>% mutate(version = 'noCutt'))

cochas.sf <- cochas %>% filter(Type == 'cocha') %>% st_as_sf(coords = c('Long', 'Lat'), crs = 4326)
mapView(cochas.sf, zcol = factor('Unique_ID'))

ggplot(cochas %>% filter(Type == 'cocha', version == 'Cut'), aes(x = year, y = area/1000000, color = con2018)) + geom_line() + 
  #geom_hline(yintercept = 1500000) + 
  facet_wrap(~Unique_ID, scales = 'free')

max(cochas$area)
hist(cochas$area)

#For jackie

out <- read.csv('out/Cocha_Areas_CutOff.csv') %>%
  select(Unique_ID, year, area) %>%
  left_join(cochaIDs) %>%
  mutate(Connectivity_2018 = ifelse(Unique_ID %in% c(3,4,5,8,9,15), T, F))

write_csv(out, 'out/CochaAreas.csv')
```


